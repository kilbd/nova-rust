<?xml version="1.0" encoding="UTF-8"?>
<syntax name="rust">
  <meta>
    <name>Rust</name>
    <type>compiled</type>
    <preferred-file-extension>rs</preferred-file-extension>
  </meta>
  
  <detectors>
    <extension priority="1.0">rs</extension>
  </detectors>
  
  <indentation>
    <increase>
      <expression>(\{[^}\"']*$)|(\[[^\]\"']*$)|(\([^)\"']*$)</expression>
    </increase>
    <decrease>
      <expression>^\s*(\s*/\*.*\*/\s*)*[\}\]\)\\]</expression>
    </decrease>
  </indentation>
  
  <comments>
    <single>
      <expression>//</expression>
    </single>
    <multiline>
      <starts-with>
        <expression>/*</expression>
      </starts-with>
      <ends-with>
        <expression>*/</expression>
      </ends-with>
    </multiline>
  </comments>
  
  <brackets>
    <pair open="{" close="}" />
    <pair open="[" close="]" />
    <pair open="(" close=")" />
    <pair open="&lt;" close="&gt;" />
  </brackets>
  
  <surrounding-pairs>
    <pair open="{" close="}" />
    <pair open="[" close="]" />
    <pair open="(" close=")" />
    <pair open="&lt;" close="&gt;" />
    <pair open="&quot;" close="&quot;" />
    <pair open="r#&quot;" close="&quot;#" />
  </surrounding-pairs>
  
  <scopes>
    <include syntax="self" collection="blocks" />
    <include syntax="self" collection="comments" />
    <include syntax="self" collection="definitions" />
    <include syntax="self" collection="identifiers" />
    <include syntax="self" collection="imports" />
    <include syntax="self" collection="processing" />
    <include syntax="self" collection="values" />
  </scopes>
  
  <collections>
    <!-- !Arguments -->
    <collection name="arguments">
      <scope name="rust.arguments">
        <starts-with>
          <expression>\(</expression>
          <capture number="0" name="rust.bracket" />
        </starts-with>
        <ends-with>
          <expression>\)</expression>
          <capture number="0" name="rust.bracket" />
        </ends-with>
        <subscopes>
          <include syntax="self" collection="argument-items" />
        </subscopes>
      </scope>
    </collection>
    
    <!-- !Argument Items -->
    <collection name="argument-items">
      <scope name="rust.separator.comma">
        <expression>,</expression>
      </scope>
      <scope name="rust.argument.self">
        <symbol type="argument" />
        <expression>(&amp;)?(?:(mut)\s+)?\b(self)\b</expression>
        <capture number="1" name="rust.operator.pointer" />
        <capture number="2" name="rust.keyword.modifier" />
        <capture number="3" name="rust.keyword.self" />
      </scope>
      <scope name="rust.argument">
        <symbol type="argument" />
        <starts-with>
          <expression>(&amp;)?(?:(mut)\s+)?\b([a-zA-Z_][A-Za-z0-9_]*)\b</expression>
          <capture number="1" name="rust.operator.pointer" />
          <capture number="2" name="rust.keyword.modifier" />
          <capture number="3" name="rust.identifier.argument.name" />
        </starts-with>
        <ends-with>
          <expression>(?=\)|,)</expression>
        </ends-with>
        <subscopes>
          <scope name="rust.argument.type">
            <starts-with>
              <expression>:</expression>
            </starts-with>
            <ends-with>
              <expression>(?=\)|,)</expression>
            </ends-with>
            <subscopes>
              <include syntax="self" collection="qualified-types" />
              <include syntax="self" collection="types" />
            </subscopes>
          </scope>
        </subscopes>
      </scope>
    </collection>
    
    <!-- !Blocks -->
    <collection name="blocks">
      <scope name="rust.block">
        <symbol type="block">
          <context behavior="subtree" />
        </symbol>
        <starts-with>
          <expression>\{</expression>
          <capture number="0" name="rust.block.bracket" />
        </starts-with>
        <ends-with>
          <expression>\}</expression>
          <capture number="0" name="rust.block.bracket" />
        </ends-with>
        <subscopes>
          <include syntax="self" />
        </subscopes>
      </scope>
    </collection>
    
    <!-- !Comments -->
    <collection name="comments">
      <scope name="comment.single.rust">
        <expression>//(?:$|([^/!].*)$)</expression>
        <capture number="1" name="comment.single.content.rust" />
      </scope>
      <scope name="comment.multiline.rust">
        <symbol type="comment">
          <context behavior="subtree" />
        </symbol>
        <starts-with>
          <expression>/\*</expression>
        </starts-with>
        <ends-with>
          <expression>\*/</expression>
        </ends-with>
      </scope>
      <scope name="string.docstring.rust">
        <expression>//[/!](.*)$</expression>
        <capture number="1" name="string.docstring.content.rust" />
      </scope>
    </collection>
    
    <!-- !Definitions -->
    <collection name="definitions">
      <!-- !Constant -->
      <scope name="definition.constant.rust">
        <symbol type="constant" scope="local" />
        <expression>\b(let)\s+(?!mut\s)([a-zA-Z_][a-zA-Z0-9_]*)(:)?\s*([a-zA-Z_][a-zA-Z0-9_]*)?\s*(\=)(?!\=)</expression>
        <capture number="1" name="keyword.construct.variable.rust" />
        <capture number="2" name="identifier.constant.rust.name" />
        <capture number="3" name="operator.rust" />
        <capture number="4" name="identifier.type.rust" />
        <capture number="5" name="operator.rust" />
      </scope>
      <!-- !Variable -->
      <scope name="definition.identifier.rust">
        <symbol type="variable" scope="local" />
        <expression>\b(let)\s+(mut)\s+([a-zA-Z_][a-zA-Z0-9_]*)(:)?\s*([a-zA-Z_][a-zA-Z0-9_]*)?\s*(\=)(?!\=)</expression>
        <capture number="1" name="keyword.construct.variable.rust" />
        <capture number="2" name="keyword.modifier.rust" />
        <capture number="3" name="identifier.rust.name" />
        <capture number="4" name="operator.rust" />
        <capture number="5" name="identifier.type.rust" />
        <capture number="6" name="operator.rust" />
      </scope>
      <!-- !Struct -->
      <scope name="definition.struct.rust">
        <symbol type="struct">
          <context behavior="subtree" />
        </symbol>
        <starts-with>
          <expression>\b(pub)?\s*(struct)\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*</expression>
          <capture number="1" name="keyword.modifier.visibility.rust" />
          <capture number="2" name="keyword.construct.struct.rust" />
          <capture number="3" name="identifier.type.struct.rust.name" />
        </starts-with>
        <ends-with>
          <expression>(?&lt;=\}|;)</expression>
        </ends-with>
        <subscopes>
          <include syntax="self" collection="generics" />
          <scope name="rust.definition.property.struct">
            <symbol type="property" />
            <starts-with>
              <expression>\b([a-zA-Z_][a-zA-Z0-9_]*)(:)</expression>
              <capture number="1" name="identifier.property.rust.name" />
              <capture number="2" name="punctuation.rust" />
            </starts-with>
            <ends-with>
              <expression>(?&lt;=,|\})</expression>
            </ends-with>
            <subscopes>
              <include syntax="self" collection="generics" />
              <include syntax="self" collection="qualified-types" />
              <include syntax="self" collection="types" />
            </subscopes>
          </scope>
        </subscopes>
      </scope>
      <!-- !Enum -->
      <scope name="rust.definition.enum">
        <symbol type="enum">
          <context behavior="subtree" />
        </symbol>
        <starts-with>
          <expression>\b(pub)?\s*(enum)\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*</expression>
          <capture number="1" name="rust.keyword.modifier.visibility" />
          <capture number="2" name="rust.keyword.construct.enum" />
          <capture number="3" name="rust.identifier.type.enum.name" />
        </starts-with>
        <ends-with>
          <expression>(?&lt;=\}|;)</expression>
        </ends-with>
        <subscopes>
          <scope name="rust.definition.enum.member">
            <symbol type="enum-member" />
            <starts-with>
              <expression>\b([a-zA-Z_][a-zA-Z0-9_]*)</expression>
              <capture number="1" name="rust.identifier.enum.member.name" />
            </starts-with>
            <ends-with>
              <expression>(?&lt;=,|\})</expression>
            </ends-with>
            <subscopes>
              <scope name="rust.definition.enum.member.type">
                <starts-with>
                  <expression>\(</expression>
                </starts-with>
                <ends-with>
                  <expression>\)</expression>
                </ends-with>
                <subscopes>
                  <include syntax="self" collection="types" />
                </subscopes>
              </scope>
              <scope name="rust.definition.enum.member.value">
                <starts-with>
                  <expression>=</expression>
                  <capture number="0" name="rust.operator" />
                </starts-with>
                <ends-with>
                  <expression>(?&lt;=,|\})</expression>
                </ends-with>
                <subscopes>
                  <include syntax="self" collection="values" />
                </subscopes>
              </scope>
            </subscopes>
          </scope>
        </subscopes>
      </scope>
      <!-- !Functions -->
      <scope name="rust.definition.function">
        <symbol type="function">
          <context behavior="subtree" foldable="false" />
        </symbol>
        <starts-with>
          <expression>\b(?:(pub)\s+)?(fn)\s+([a-zA-Z_][a-zA-Z0-9_]*)\b</expression>
          <capture number="1" name="rust.keyword.modifier.visibility" />
          <capture number="2" name="rust.keyword.construct.function" />
          <capture number="3" name="rust.identifier.function.name" />
        </starts-with>
        <ends-with />
        <subscopes anchored="true">
          <include syntax="self" collection="generics" optional="true" />
          <include syntax="self" collection="arguments" />
          <include syntax="self" collection="return-types" optional="true" />
          <include syntax="self" collection="function-blocks" />
        </subscopes>
      </scope>
    </collection>
    
    <!-- !Function Blocks -->
    <collection name="function-blocks">
      <scope name="rust.block">
        <symbol type="block">
          <context behavior="subtree" fold-type="function" />
        </symbol>
        <starts-with>
          <expression>\{</expression>
          <capture number="0" name="rust.bracket" />
        </starts-with>
        <ends-with>
          <expression>\}</expression>
          <capture number="0" name="rust.bracket" />
        </ends-with>
        <subscopes>
          <include syntax="self" />
        </subscopes>
      </scope>
    </collection>
    
    <!-- !Generics -->
    <collection name="generics">
      <scope name="generic.type.rust">
        <starts-with>
          <expression>&lt;</expression>
          <capture number="0" name="bracket.generic.rust" />
        </starts-with>
        <ends-with>
          <expression>&gt;</expression>
          <capture number="0" name="bracket.generic.rust" />
        </ends-with>
        <subscopes>
          <include syntax="self" collection="generics" />
          <include syntax="self" collection="lifetimes" />
          <include syntax="self" collection="types" />
          <scope name="punctuation.separator.rust">
            <expression>,</expression>
          </scope>
        </subscopes>
      </scope>
    </collection>
    
    <!-- !Identifiers -->
    <collection name="identifiers">
      <scope name="rust.identifier.core.type.primitive">
        <strings>
          <string>bool</string>
          <string>char</string>
          <string>f32</string>
          <string>f64</string>
          <string>i8</string>
          <string>i16</string>
          <string>i32</string>
          <string>i64</string>
          <string>i128</string>
          <string>isize</string>
          <string>str</string>
          <string>u8</string>
          <string>u16</string>
          <string>u32</string>
          <string>u64</string>
          <string>u128</string>
          <string>usize</string>
        </strings>
      </scope>
      <scope name="rust.identifier.core.type.enum">
        <strings>
          <string>Option</string>
          <string>Some</string>
          <string>None</string>
          <string>Result</string>
          <string>Ok</string>
          <string>Err</string>
        </strings>
      </scope>
      <scope name="rust.identifier.core.type.struct">
        <strings>
          <string>Box</string>
          <string>Path</string>
          <string>PathBuf</string>
          <string>String</string>
          <string>Vec</string>
        </strings>
      </scope>
      <scope name="rust.identifier.property">
        <expression>(?&lt;=\.)([a-zA-Z_\$][A-Za-z0-9_]*)\b(?!\()</expression>
      </scope>
      <scope name="rust.identifier.property.static">
        <expression>(?&lt;=\:\:)([a-zA-Z_\$][A-Za-z0-9_]*)\b(?!\()</expression>
      </scope>
      <scope name="rust.identifier.method">
        <expression>(?&lt;=\.)([a-zA-Z_\$][A-Za-z0-9_]*)(?=\()</expression>
      </scope>
      <scope name="rust.identifier.method.static">
        <expression>(?&lt;=\:\:)([a-zA-Z_\$][A-Za-z0-9_]*)(?=\()</expression>
      </scope>
      <scope name="typescript.identifier.function">
        <expression>(?&lt;!\.)((?:\b[a-zA-Z_]|\$)[A-Za-z0-9_]*)(?=\()</expression>
      </scope>
    </collection>
    
    <!-- !Imports -->
    <collection name="imports">
      <scope name="rust.import">
        <starts-with>
          <expression>\b(?:(pub)\s+)?(use)\b</expression>
          <capture number="1" name="rust.keyword.modifier.visibility" />
          <capture number="2" name="rust.keyword.statement.import" />
        </starts-with>
        <ends-with>
          <expression>\;</expression>
          <capture number="0" name="rust.punctuation.semicolon" />
        </ends-with>
        <subscopes>
          <scope name="rust.import.destructured">
            <starts-with>
              <expression>\{</expression>
              <capture number="0" name="rust.bracket" />
            </starts-with>
            <ends-with>
              <expression>\}</expression>
              <capture number="0" name="rust.bracket" />
            </ends-with>
            <subscopes>
              <scope name="rust.import.item">
                <expression>\b([a-zA-Z_][a-zA-Z0-9_]*)(?:\s+(as)\s+([a-zA-Z_][a-zA-Z0-9_]*))?\,?\b</expression>
                <capture number="1" name="rust.identifier" />
                <capture number="2" name="rust.keyword.modifier" />
                <capture number="3" name="rust.identifier" />
              </scope>
            </subscopes>
          </scope>
          <scope name="rust.import.single">
            <expression>\b([a-zA-Z_][a-zA-Z0-9_]*)(::)?</expression>
            <capture number="1" name="rust.identifier" />
            <capture number="2" name="rust.operator" />
          </scope>
        </subscopes>
      </scope>
      <scope name="rust.import.module">
        <expression>\b(?:(pub)\s+)?(mod)\s+([a-zA-Z_][a-zA-Z0-9_]*)\;</expression>
        <capture number="1" name="rust.keyword.modifier.visibility" />
        <capture number="2" name="rust.keyword.statement.module" />
        <capture number="3" name="rust.identifier" />
      </scope>
    </collection>
    
    <!-- !Lifetimes -->
    <collection name="lifetimes">
      <scope name="decorator.lifetime.rust">
        <expression>&apos;[a-zA-Z_][a-zA-Z0-9_]*</expression>
        <capture number="0" name="identifier.decorator.lifetime.name.rust" />
      </scope>
    </collection>
    
    <!-- !Processing -->
    <collection name="processing">
      <scope name="rust.processing">
        <starts-with>
          <expression>\#\[</expression>
        </starts-with>
        <ends-with>
          <expression>\]</expression>
        </ends-with>
      </scope>
    </collection>
    
    <!-- !Qualified Types -->
    <collection name="qualified-types">
      <scope name="rust.type.qualified">
        <starts-with>
          <expression>&amp;</expression>
          <capture number="0" name="rust.operator.pointer" />
        </starts-with>
        <ends-with>
          <expression>(?=\,|\)|\}|\;)</expression>
        </ends-with>
        <subscopes anchored="true">
          <include syntax="self" collection="lifetimes" optional="true" />
          <scope name="rust.keyword.modifier" optional="true">
            <strings>
              <string>mut</string>
            </strings>
          </scope>
          <include syntax="self" collection="types" />
        </subscopes>
      </scope>
    </collection>
    
    <!-- !Return Types -->
    <collection name="return-types">
      <scope name="rust.return-type" optional="true">
        <starts-with>
          <expression>(\-&gt;)\s*(\()?</expression>
          <capture number="1" name="rust.operator.return" />
          <capture number="2" name="rust.bracket" />
        </starts-with>
        <ends-with>
          <expression>(\))|(?=\{|\,|\;)|$</expression>
          <capture number="1" name="rust.bracket" />
        </ends-with>
        <subscopes>
          <include syntax="self" collection="qualified-types" />
          <include syntax="self" collection="types" />
        </subscopes>
      </scope>
    </collection>
    
    <!-- !Types -->
    <collection name="types">
      <scope name="identifier.type.rust">
        <expression>(\[)?([a-zA-Z_][a-zA-Z0-9_]*)(\])?</expression>
        <capture number="1" name="operator.array.bracket.rust" />
        <capture number="3" name="operator.array.bracket.rust" />
      </scope>
    </collection>
    
    <!-- !Values -->
    <collection name="values">
      <!-- Strings -->
      <scope name="string.rust">
        <starts-with>
          <expression>&quot;</expression>
        </starts-with>
        <ends-with>
          <expression>&quot;</expression>
        </ends-with>
        <subscopes>
          <scope name="string.escaped.rust">
            <expression>\\[\\&quot;]</expression>
          </scope>
        </subscopes>
      </scope>
      <scope name="string.raw.rust">
        <starts-with>
          <expression>\br&quot;</expression>
        </starts-with>
        <ends-with>
          <expression>&quot;</expression>
        </ends-with>
      </scope>
      <scope name="string.raw.quote.rust">
        <starts-with>
          <expression>\br\#+&quot;</expression>
        </starts-with>
        <ends-with>
          <expression>&quot;\#+</expression>
        </ends-with>
      </scope>
      <scope name="string.char.rust">
        <expression>&apos;(.)&apos;</expression>
        <capture number="1" name="value.char.rust" />
      </scope>
      <!-- Booleans -->
      <scope name="value.boolean.rust">
        <strings>
          <string>true</string>
          <string>false</string>
        </strings>
      </scope>
      <!-- Numbers -->
      <scope name="value.number.float.rust">
        <expression>\b-?[0-9]+(?:\.[0-9]+)?(?:f32|f64)?\b</expression>
      </scope>
      <scope name="value.number.integer.rust">
          <expression>\b-?[0-9][0-9_]*(?:[iu](?:8|16|32|64|128|size))?\b</expression>
      </scope>
      <scope name="value.number.hexadecimal.rust">
        <expression>\b0[xX][a-fA-F0-9]+\b</expression>
      </scope>
      <scope name="value.number.octal.rust">
        <expression>\b0[0-7]+\b</expression>
      </scope>
    </collection>
    
  </collections>
</syntax>
